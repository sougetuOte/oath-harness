# コミットコマンド

引数: $ARGUMENTS（変更の概要メモ。省略可。コミットメッセージはグループごとに自動生成）

ドキュメント同期チェック付きの日常コミットフロー。
「変更確認 → ドキュメント同期 → 論理グループ分類 → 承認 → コミット → プッシュ」を一気通貫で行う。

## Step 1: 変更内容の把握

1. `git status` で変更ファイルを確認
2. `git diff` でステージ済み・未ステージの差分を確認
3. 変更がない場合は「コミットするものがありません」と報告して終了

## Step 2: ドキュメント同期チェック

以下のチェックを順に実行し、不整合があれば **自動修正** する。

### 2a. テスト数同期

1. `bash tests/run-all-tests.sh` を実行してテスト数をカウント
   - 出力から全体・単体・統合の各テスト数を抽出
2. 以下のファイルのテスト数表記と比較:
   - `CLAUDE.md` — Testing セクションの件数
   - `README.md` — テスト数の言及箇所
   - `README_ja.md` — テスト数の言及箇所
3. 不一致があれば該当箇所を更新

### 2b. CLAUDE.md 構造チェック

1. `Module Structure` セクションの `lib/`, `hooks/`, `bin/` ツリーが実ファイル構成と一致するか確認
2. `Development Status` セクションが現状を反映しているか確認
3. 不一致があれば更新

### 2c. README.md / README_ja.md セクションチェック

1. 今回の変更で新しいコマンドや機能が追加された場合、README に対応セクションがあるか確認
2. 不足があれば追記を提案（大きな変更の場合のみ。軽微な修正では不要）

### チェック省略条件

- ドキュメントファイルのみの変更（.md のみ）の場合、2a のテスト数チェックはスキップ
- テストファイルのみの変更の場合、2b〜2c はスキップ

## Step 3: 論理グループ分類 & 承認

### 3a. 変更を論理グループに分類

変更ファイルを目的・関連性に基づいて **最大3グループ** に分類する。

分類の指針:
- 機能実装とそのテストは同じグループ
- ドキュメント同期（Step 2 での自動修正）は独立グループにまとめる
- 設定変更は独立グループ
- 3グループを超える場合は関連性で統合

例:
```
グループ1: feat: Add /commit command
  - .claude/commands/commit.md

グループ2: docs: Update CHANGELOG for /commit command
  - CHANGELOG.md
```

### 3b. 承認

以下をユーザーに提示して承認を待つ:

```
--- コミット確認 ---
ドキュメント同期:
  [修正した内容 / 修正不要だった旨]

コミット計画:
  [1] メッセージ: ...
      ファイル: ...
  [2] メッセージ: ...
      ファイル: ...

プッシュ: コミット後に実行

この内容でコミット＆プッシュしますか？
---
```

- 各グループのコミットメッセージは変更内容から自動生成
  - prefix を使う（feat/fix/docs/chore/refactor/test 等）
- ユーザーが「承認」と言うまで次へ進まない
- ユーザーがグループ分割やメッセージの修正を指示した場合は修正して再提示

## Step 4: コミット＆プッシュ

1. グループごとに順番に `git add` + `git commit` を実行
   - `git add` は対象ファイルを明示的に指定（`git add .` は使わない）
   - 秘密情報ファイル（.env, credentials 等）は除外
   - コミットメッセージ末尾に `Co-Authored-By: Claude <noreply@anthropic.com>` を付与
2. 全グループのコミット完了後、`git push` を実行
   - リモートが設定されていない場合はスキップして報告
3. 完了報告:

```
--- commit 完了 ---
コミット:
  [1] [hash] メッセージ (N files)
  [2] [hash] メッセージ (N files)
プッシュ: 完了 / スキップ
ドキュメント同期: [修正した項目 / なし]
---
```

4. 完了報告の後、`/quick-save` の実行を案内する:
   - 「セッション状態を保存するには `/quick-save` をどうぞ」

## 安全装置

- 各 git 操作前にユーザー確認を挟む
- `--force` 系のコマンドは一切使わない
- Step 2 の自動修正内容は Step 3 で必ずユーザーに提示する
