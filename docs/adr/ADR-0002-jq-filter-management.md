# ADR-0002: jq フィルタ管理

**Status**: Accepted
**Date**: 2026-02-23
**Context**: oath-harness Phase 1 (MVP)

## Context

oath-harness では JSON の永続化・読み書きに `jq` を多用する。
jq フィルタをインラインの bash ヒアドキュメントやワンライナーとして埋め込むか、
外部ファイル（`lib/jq/*.jq`）として分離管理するかを決定する必要がある。

インラインで書いた場合、短いフィルタは読みやすいが、3行を超えるフィルタは
bash の文字列エスケープと混在して著しく可読性が低下する。

## Decision

**3行を超える jq フィルタは `lib/jq/` ディレクトリに外部ファイルとして分離して管理する。**

3行以内の単純なフィルタ（フィールド参照・単純な変換）はインラインのまま維持する。

外部ファイルを使用する場合の呼び出し規約:

```bash
jq --from-file "${OATH_HARNESS_ROOT}/lib/jq/update-trust-score.jq" \
   --argjson delta "${delta}" \
   "${state_file}"
```

ファイル命名規則: `<操作>-<対象>.jq`（例: `update-trust-score.jq`、`calc-autonomy.jq`）

## Consequences

### Positive

- 複雑な jq フィルタが bash の引用符・エスケープから切り離され、可読性が向上する
- `.jq` ファイル単体でのテストが可能になる（`jq -n -f filter.jq` による単体検証）
- エディタの jq シンタックスハイライトが有効になる
- 同じフィルタを複数のシェルスクリプトから再利用できる

### Negative

- ファイル数が増え、`lib/jq/` の管理が必要になる
- 外部ファイルのパスを正しく解決する必要があり、`OATH_HARNESS_ROOT` 変数の設定が前提となる
- 開発者がフィルタを探す際に bash ファイルと jq ファイルを行き来する必要がある

### Risks

- `lib/jq/` ファイルが bash スクリプトとは別にバージョン管理されるため、
  両者の整合性が崩れるリスクがある
  - 緩和策: 関連する `.jq` ファイルと `.sh` ファイルを同一コミットで変更する規約を設ける
- パスが解決できない環境（シンボリックリンク経由で実行する場合など）で動作しないリスクがある
  - 緩和策: `OATH_HARNESS_ROOT` を明示的に設定するインストーラを用意する
